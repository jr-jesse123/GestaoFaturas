# Database Schema

This is the database schema implementation for the spec detailed in @.agent-os/specs/2025-09-02-client-responsible-person-crud/spec.md

## Database Changes

### New Table: ResponsiblePersons

```sql
CREATE TABLE "ResponsiblePersons" (
    "Id" integer GENERATED BY DEFAULT AS IDENTITY,
    "ClientId" integer NOT NULL,
    "Name" text NOT NULL,
    "Email" text NOT NULL,
    "Phone" text,
    "Role" text,
    "IsPrimary" boolean NOT NULL DEFAULT FALSE,
    "CreatedAt" timestamp with time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "UpdatedAt" timestamp with time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "PK_ResponsiblePersons" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_ResponsiblePersons_Clients_ClientId" FOREIGN KEY ("ClientId") REFERENCES "Clients" ("Id") ON DELETE CASCADE
);
```

### Indexes and Constraints

```sql
-- Index for efficient client lookups
CREATE INDEX "IX_ResponsiblePersons_ClientId" ON "ResponsiblePersons" ("ClientId");

-- Index for email lookups
CREATE INDEX "IX_ResponsiblePersons_Email" ON "ResponsiblePersons" ("Email");

-- Unique constraint to ensure only one primary contact per client
CREATE UNIQUE INDEX "IX_ResponsiblePersons_ClientId_IsPrimary" ON "ResponsiblePersons" ("ClientId") WHERE "IsPrimary" = TRUE;
```

### Entity Framework Migration

```csharp
public partial class AddResponsiblePersons : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.CreateTable(
            name: "ResponsiblePersons",
            columns: table => new
            {
                Id = table.Column<int>(type: "integer", nullable: false)
                    .Annotation("Npgsql:ValueGenerationStrategy", NpgsqlValueGenerationStrategy.IdentityByDefaultColumn),
                ClientId = table.Column<int>(type: "integer", nullable: false),
                Name = table.Column<string>(type: "text", nullable: false),
                Email = table.Column<string>(type: "text", nullable: false),
                Phone = table.Column<string>(type: "text", nullable: true),
                Role = table.Column<string>(type: "text", nullable: true),
                IsPrimary = table.Column<bool>(type: "boolean", nullable: false, defaultValue: false),
                CreatedAt = table.Column<DateTime>(type: "timestamp with time zone", nullable: false, defaultValueSql: "CURRENT_TIMESTAMP"),
                UpdatedAt = table.Column<DateTime>(type: "timestamp with time zone", nullable: false, defaultValueSql: "CURRENT_TIMESTAMP")
            },
            constraints: table =>
            {
                table.PrimaryKey("PK_ResponsiblePersons", x => x.Id);
                table.ForeignKey(
                    name: "FK_ResponsiblePersons_Clients_ClientId",
                    column: x => x.ClientId,
                    principalTable: "Clients",
                    principalColumn: "Id",
                    onDelete: ReferentialAction.Cascade);
            });

        migrationBuilder.CreateIndex(
            name: "IX_ResponsiblePersons_ClientId",
            table: "ResponsiblePersons",
            column: "ClientId");

        migrationBuilder.CreateIndex(
            name: "IX_ResponsiblePersons_Email",
            table: "ResponsiblePersons",
            column: "Email");

        migrationBuilder.CreateIndex(
            name: "IX_ResponsiblePersons_ClientId_IsPrimary",
            table: "ResponsiblePersons",
            column: "ClientId",
            unique: true,
            filter: "\"IsPrimary\" = TRUE");
    }

    protected override void Down(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.DropTable(name: "ResponsiblePersons");
    }
}
```

## Rationale

- **Foreign Key Cascade**: When a client is deleted, all associated responsible persons are automatically deleted to maintain data integrity
- **Primary Contact Constraint**: Unique partial index ensures only one primary contact per client while allowing multiple non-primary contacts
- **Timestamps**: CreatedAt and UpdatedAt fields for audit trails and data tracking
- **Email Index**: Improves performance for email-based lookups and validation
- **Nullable Fields**: Phone and Role are optional to accommodate varying client requirements